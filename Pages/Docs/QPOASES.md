# QPOASES 최적화 관련 정리

## QPOases 최적화 기본 과정

1. **문제 정의 및 초기화**  
   이차 계획법 문제를 정의
   
   minimize \(0.5 \cdot x^T \cdot H \cdot x + g^T \cdot x\) 
   
   subject to \(lb \leq x \leq ub\), \(lbA \leq A \cdot x \leq ubA\) 

2. **QProblem 객체 생성 및 행렬/벡터 데이터 초기화**

3. **초기 활성 집합 결정**  
   초기 활성 제약조건(active constraints) 집합 구성  
   기본적으로 모든 제약조건이 비활성 상태로 시작

4. **KKT(Karush-Kuhn-Tucker) 시스템 구성**  
   현재 활성 집합에 대한 KKT 시스템 구성  
   이 시스템은 최적성 조건을 반영

5. **KKT 시스템 해결**  
   Cholesky 분해 등의 방법으로 KKT 시스템 해결

6. **프라이멀(primal) 및 듀얼(dual) 변수 업데이트**

7. **최적성 검사**  
   Lagrange 승수(multipliers)를 계산하여 KKT 조건 충족 여부 확인  
   모든 제약조건의 Lagrange 승수가 비음수이면 현재 해는 최적해

8. **활성 집합 업데이트**  
   최적성이 만족되지 않으면, 가장 위반이 심한 제약조건을 활성/비활성으로 전환  
   보통 가장 작은(negative) Lagrange 승수를 가진 제약조건을 활성 집합에서 제거

9. **방향 계산 및 스텝 크기 결정**  
   이동 방향 계산  
   제약조건을 위반하지 않는 최대 스텝 크기 결정

10. **해 업데이트 및 반복**  
    계산된 방향과 스텝 크기로 현재 해 업데이트  
    3~7단계 반복(최적해 찾을 때까지 또는 최대 반복 횟수 도달할 때까지)

11. **종료 조건 확인**  
    KKT 조건이 충족되었는지 확인  
    최대 반복 횟수에 도달했는지 확인  
    수렴 여부 확인

12. **해 반환**  
    최적화된 변수 값(x)과 상태 정보 반환

## 활성 집합 방법(Active Set Method)

활성 집합 방법은 제약 최적화 문제를 해결하는 알고리즘입니다. 기본 아이디어는 다음과 같습니다:

- **활성 제약조건(Active Constraint)**: 해당 시점에서 등식으로 만족되는 부등식 제약조건들입니다.  
  예: \(x \leq 5\)라는 제약조건에서 \(x = 5\)일 때 이 제약조건은 활성 상태입니다.

- **활성 집합(Active Set)**: 현재 활성화된 제약조건들의 집합입니다.

### 기본 작동 원리:

1. 초기 실행 가능한 점에서 시작
2. 현재 활성 집합에 대한 최적화 문제를 해결(제약조건을 등식으로 취급)
3. 최적성 조건(KKT) 검사
4. 필요시 활성 집합 업데이트(제약조건 추가/제거)
5. 최적해를 찾을 때까지 반복

이 방법은 특히 이차 계획법(QP) 문제에 효과적으로, 활성 집합이 식별되면 문제가 등식 제약조건만 가진 더 간단한 문제로 변환됩니다.

## KKT(Karush-Kuhn-Tucker) 조건

KKT 조건은 비선형 최적화 문제의 최적해를 위한 필요 조건입니다:

- **정의**: 부등식 제약조건이 있는 최적화 문제에서 최적해의 필요조건을 수학적으로 정의합니다.

### 주요 구성요소:

- **정상성(Stationarity)**: \(\nabla f(x^*) + \sum \lambda_i \nabla g_i(x^*) + \sum \mu_j \nabla h_j(x^*) = 0\)  
  \(f\)는 목적함수, \(g\)는 부등식 제약조건, \(h\)는 등식 제약조건

- **프라이멀 실행가능성(Primal Feasibility)**: \(g_i(x^*) \leq 0\), \(h_j(x^*) = 0\)

- **듀얼 실행가능성(Dual Feasibility)**: \(\lambda_i \geq 0\) (부등식 제약조건의 Lagrange 승수)

- **상보적 여유(Complementary Slackness)**: \(\lambda_i g_i(x^*) = 0\)

### 해석:

- 최적점에서 목적함수와 제약조건의 기울기는 서로 반대 방향이어야 함
- 활성 제약조건만이 최적해에 영향을 미침

QP 문제에서 KKT 조건은 선형 방정식 시스템으로 바뀌어 직접 해결될 수 있습니다.

## Cholesky 분해

Cholesky 분해는 대칭 양정치(symmetric positive-definite) 행렬을 하삼각 행렬과 그 전치행렬의 곱으로 분해하는 방법입니다:

- **수학적 표현**: \(A = LL^T\)  
  \(A\): 대칭 양정치 행렬  
  \(L\): 하삼각 행렬 (대각선 아래쪽 원소만 0이 아님)  
  \(L^T\): \(L\)의 전치행렬

### 계산 과정:

- \(L\)의 원소들을 \(A\)의 원소들로부터 계산
- 대각 원소: \(L_{(j,j)} = \sqrt{A_{(j,j)} - \sum_{k=1}^{j-1} L^2_{(j,k)}}\)
- 비대각 원소: \(L_{(i,j)} = \frac{A_{(i,j)} - \sum_{k=1}^{j-1} L_{(i,k)}L_{(j,k)}}{L_{(j,j)}} \quad (i > j)\)

### QPOases에서의 응용:

- KKT 시스템을 효율적으로 해결하기 위해 사용
- 행렬 방정식 \(Ax = b\)를 두 단계로 해결:  
  \(Ly = b\) (전방 대입)  
  \(L^Tx = y\) (후방 대입)

### 장점:

- **계산 효율성**: 가우스 소거법보다 약 2배 빠름
- **수치적 안정성**: 양정치 행렬에 대해 특히 안정적
- **저장 공간 효율성**: 대칭성으로 인해 행렬의 절반만 저장

QPOases에서는 이러한 방법들을 조합하여 최적화 문제를 효율적으로 해결합니다. 활성 집합 방법으로 문제를 체계적으로 접근하고, KKT 조건으로 최적성을 평가하며, Cholesky 분해로 발생하는 선형 시스템을 효율적으로 해결합니다. 